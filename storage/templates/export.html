{% extends 'base.html' %}
{% load crispy_forms_tags %}
{% load django_tables2 %}
{% load static %}
{% load custom_filters %}

{% block content %}

    <!-- Export Type Tabs -->
    <div class="card">
        <div class="card-header">
            <div class="text-center me-5">
                <h4>سجل الصــرف</h4>
            </div>
            <ul class="nav nav-tabs card-header-tabs">
                <li class="nav-item">
                    <a class="nav-link {% if not export_type %}active{% endif %}" 
                       href="?{{ request.GET|build_query:'export_type' }}">الكل</a>
                </li>
                {% for export_type_value, export_type_label in export_types.items %}
                    <li class="nav-item">
                        <a class="nav-link {% if export_type_value == export_type %}active{% endif %}" 
                           href="?export_type={{ export_type_value }}&{{ request.GET|build_query:'export_type' }}">
                        {{ export_type_label }}
                        </a>
                    </li>
                {% endfor %}
            </ul>
            
        </div>
            <div class="card-body">
            {% if messages %}
                <div class="alert-container mb-3">
                    {% for message in messages %}
                        <div class="alert alert-{{ message.tags }} ">
                            {{ message }}
                        </div>
                    {% endfor %}
                </div>
            {% endif %}

            <div class="row mt-2 mb-2">
                <div class="col-sm-auto">
                    <!-- "Add New Record" Button -->
                    <div class="form-group">
                        <a href="{% url 'export_create' export_type=export_type %}" class="btn btn-primary text-nowrap">اذن جديد</a>
                    </div>
                </div>            
                <!-- Filters (Search, Date Range, etc.) -->
                <form method="GET" class="col row" id="search-form">
                    <div class="col-sm-auto mb-2">
                        <div class="form-group">
                            <input type="text" placeholder="بحث بالرقم" name="trans_id" id="trans_id" class="form-control" value="{{ request.GET.trans_id }}">
                        </div>
                    </div>
                    <div class="col-sm-auto">
                        <div class="form-group">
                            <input type="text" placeholder="بحث بالكلمات" name="search" id="search" class="form-control" value="{{ request.GET.search }}">
                        </div>
                    </div>
                        <!-- Add the export type to the form to retain the selected tab -->
                        {% if export_type %}
                        <input type="hidden" name="export_type" value="{{ export_type }}">
                        {% endif %}
                    <div class="col-sm-auto">
                        <div class="form-group">
                            <input type="date" placeholder="تاريخ البداية" name="start_date" id="start_date" class="form-control flatpickr" value="{{ request.GET.start_date }}">
                        </div>
                    </div>
                    <div class="col-sm-auto">
                        <div class="form-group">
                            <input type="date" placeholder="تاريخ النهاية" name="end_date" id="end_date" class="form-control flatpickr" value="{{ request.GET.end_date }}">
                        </div>
                    </div>
                    <div class="col-sm-auto">
                        <div class="form-group">
                            <button type="submit" class="btn btn-secondary">بحث</button>
                            {% if request.GET|has_non_sort_params:"sort, export_type" %}
                            <button type="button" id="reset-btn" class="btn btn-warning">Reset</button>
                        {% endif %}
                        </div>
                    </div>
                </form>
            </div>
            <!-- Render the tables for the selected export type -->
            {% if export_tables %}
                <div class="table-responsive">
                    {% for export_type_label, table in export_tables.items %}
                        {% render_table table %}
                    {% endfor %}
                </div>
            {% else %}
                <p>لا توجد بيانات لعرضها.</p>
            {% endif %}
        </div>
    </div>

{% endblock %}

{% block scripts %}
    <link rel="stylesheet" href="{% static 'flatpickr/flatpickr.min.css' %}">
    <script src="{% static 'flatpickr/flatpickr.min.js' %}"></script>
    <script src="{% static 'flatpickr/locale/ar.js' %}"></script>

    <script>
        // Function to open the Export Record form dynamically based on the selected tab
        function openExportForm(exportType) {
            // Set the export type dynamically
            document.getElementById('export_type').value = exportType;

        }
    </script>

    <script>
        // Auto-hide messages after 5 seconds (5000 ms)
        setTimeout(function() {
            const alerts = document.querySelectorAll('.alert');
            alerts.forEach(alert => {
                alert.style.transition = "opacity 0.5s";
                alert.style.opacity = 0;
                setTimeout(() => alert.remove(), 500); // Fully remove after fade-out
            });
        }, 3000);
    </script>


    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const resetButton = document.getElementById('reset-btn');
            const form = document.getElementById('search-form');
    
            resetButton.addEventListener('click', function () {
                const urlParams = new URLSearchParams(window.location.search);
    
                // Parameters to remove
                const paramsToRemove = ['trans_id', 'search', 'start_date', 'end_date'];
    
                // Remove specified parameters
                paramsToRemove.forEach(param => urlParams.delete(param));
    
                // Construct the new URL
                const newUrl = `${window.location.pathname}?${urlParams.toString()}`;
    
                // Reload the page with the new URL
                window.location.href = newUrl;
            });
        });
    </script>

    <script>
        // Script to store Record Fields in Session between Item additions
        document.addEventListener('DOMContentLoaded', function () {
            const storageKey = 'exportRecordFormData'; // The key to check in sessionStorage

            // Check if the key exists in sessionStorage
            if (sessionStorage.getItem(storageKey)) {
                console.log(`"${storageKey}" exists in sessionStorage.`);
                
                // Optionally remove the key if it exists
                sessionStorage.removeItem(storageKey);
                console.log(`"${storageKey}" has been removed from sessionStorage.`);
            } else {
                console.log(`"${storageKey}" does not exist in sessionStorage.`);
            }
        });
    </script>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize Flatpickr on all elements with the class 'flatpickr'
            flatpickr('.flatpickr', {
                dateFormat: "Y-m-d", // Set the desired date format
                position: "auto center",
                locale: "ar",
                altInput: true, // Show the input field
                altFormat: "d F Y", // Display format
            });
        });
    </script>

{% endblock %}
